name: Build & Release

on:
  push:
    tags:
      - 'v*'          # 任何 v 开头的 tag 触发，如 v0.2.4

# 允许写入 GitHub Release
permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────
  # 1. 创建 GitHub Release（先行，后续 job 上传产物）
  # ─────────────────────────────────────────────
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME}"
          echo "Extracting changelog for $VERSION"

          # 从 CHANGELOG.md 提取当前版本的内容（两个 ## 之间的部分）
          python3 - <<'EOF'
          import re, os, sys

          version = os.environ.get("GITHUB_REF_NAME", "")
          with open("CHANGELOG.md", "r", encoding="utf-8") as f:
              content = f.read()

          # 匹配 ## [vX.Y.Z] 开头的段落，提取到下一个 ## 之前
          pattern = re.compile(
              r'^## \[' + re.escape(version) + r'\].*?\n(.*?)(?=^## \[|\Z)',
              re.MULTILINE | re.DOTALL
          )
          m = pattern.search(content)
          notes = m.group(1).strip() if m else "_No changelog entry found for this version._"

          # 拼接下载表格
          body = f"""## LynxShell {version}

          {notes}

          ---

          ### 下载 / Downloads
          | 平台 | 文件 | 说明 |
          |------|------|------|
          | Windows x64 | `*.msi` / `*-setup.exe` | Windows 安装包 |
          | macOS (Apple Silicon) | `*_aarch64.dmg` | macOS ARM64 磁盘映像 |
          | macOS (Intel) | `*_x64.dmg` | macOS x64 磁盘映像 |
          | Linux x64 | `.AppImage` / `.deb` | Linux 可执行文件与安装包 |
          | Android | `.apk` | 安卓手机安装包 |
          | iOS | `*.ipa` (需签名) | iOS 移动端应用包 (通常需自行签名部署) |

          > 源码包由 GitHub 自动生成，见下方 **Assets** 中的 `Source code`。
          """

          # 写入 GitHub Output（多行）
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("notes<<NOTES_EOF\n")
              f.write(body + "\n")
              f.write("NOTES_EOF\n")
          EOF

      - name: Create GitHub Release
        id: create
        uses: softprops/action-gh-release@v2
        with:
          name: LynxShell ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          body: ${{ steps.changelog.outputs.notes }}

  # ─────────────────────────────────────────────
  # 2. Windows 构建 (x64)
  # ─────────────────────────────────────────────
  build-windows:
    name: Build Windows (x64)
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        shell: powershell
        run: |
          $ver = $env:GITHUB_REF_NAME.TrimStart('v')
          Write-Host "Setting version to $ver"

          # 更新 tauri.conf.json 中的版本
          $tauriConf = Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json
          $tauriConf.version = $ver
          $tauriConf | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json

          # 更新 package.json 中的版本
          npm version $ver --no-git-tag-version --allow-same-version

      - name: Build Tauri App (Windows)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe

  # ─────────────────────────────────────────────
  # 3. macOS 构建 (Apple Silicon - aarch64)
  # ─────────────────────────────────────────────
  build-macos-aarch64:
    name: Build macOS (Apple Silicon)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          # 更新 tauri.conf.json 中的版本 (使用 node 脚本以保持 JSON 格式)
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          # 更新 package.json 中的版本
          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS aarch64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target aarch64-apple-darwin

      - name: Upload macOS (aarch64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  # ─────────────────────────────────────────────
  # 4. macOS 构建 (Intel - x64)
  # ─────────────────────────────────────────────
  build-macos-x64:
    name: Build macOS (Intel x64)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS x64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target x86_64-apple-darwin

      - name: Upload macOS (x64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  # ─────────────────────────────────────────────
  # 5. Linux 构建 (x64)
  # ─────────────────────────────────────────────
  build-linux:
    name: Build Linux (x64)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (Linux)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb

  # ─────────────────────────────────────────────
  # 6. Android 构建
  # ─────────────────────────────────────────────
  build-android:
    name: Build Android
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: sdkmanager --install "ndk;27.0.12077973"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Initialize Tauri Android project
        run: npx tauri android init

      - name: Build Tauri App (Android APK)
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.12077973
        run: npx tauri android build

      - name: Rename Android artifacts
        run: |
          mkdir -p android-artifacts
          VER="${GITHUB_REF_NAME#v}"
          
          # 查找并重命名 APK
          find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" | while read -r file; do
            filename=$(basename "$file")
            # 重命名为 LynxShell_版本_原文件名
            cp "$file" "android-artifacts/LynxShell_${VER}_${filename}"
          done
          
          # 查找并重命名 AAB
          find src-tauri/gen/android/app/build/outputs/bundle -name "*.aab" | while read -r file; do
            filename=$(basename "$file")
            cp "$file" "android-artifacts/LynxShell_${VER}_${filename}"
          done

      - name: Upload Android artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-artifacts/*

name: Build & Release

on:
  push:
    tags:
      - 'v*'          # 任何 v 开头的 tag 触发，如 v0.2.4

# 允许写入 GitHub Release
permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────
  # 1. 创建 GitHub Release（先行，后续 job 上传产物）
  # ─────────────────────────────────────────────
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        id: create
        uses: softprops/action-gh-release@v2
        with:
          name: OpenSSH ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          body: |
            ## OpenSSH ${{ github.ref_name }}

            ### 下载 / Downloads
            | 平台 | 文件 | 说明 |
            |------|------|------|
            | Windows x64 | `*.msi` / `*-setup.exe` | Windows 安装包 |
            | macOS (Apple Silicon) | `*_aarch64.dmg` | macOS ARM64 磁盘映像 |
            | macOS (Intel) | `*_x64.dmg` | macOS x64 磁盘映像 |

            > 源码包由 GitHub 自动生成，见下方 **Assets** 中的 `Source code`。

  # ─────────────────────────────────────────────
  # 2. Windows 构建 (x64)
  # ─────────────────────────────────────────────
  build-windows:
    name: Build Windows (x64)
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        shell: powershell
        run: |
          $ver = $env:GITHUB_REF_NAME.TrimStart('v')
          Write-Host "Setting version to $ver"

          # 更新 tauri.conf.json 中的版本
          $tauriConf = Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json
          $tauriConf.version = $ver
          $tauriConf | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json

          # 更新 package.json 中的版本
          npm version $ver --no-git-tag-version --allow-same-version

      - name: Build Tauri App (Windows)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe

  # ─────────────────────────────────────────────
  # 3. macOS 构建 (Apple Silicon - aarch64)
  # ─────────────────────────────────────────────
  build-macos-aarch64:
    name: Build macOS (Apple Silicon)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          # 更新 tauri.conf.json 中的版本 (使用 node 脚本以保持 JSON 格式)
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          # 更新 package.json 中的版本
          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS aarch64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri
          args: --target aarch64-apple-darwin

      - name: Upload macOS (aarch64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  # ─────────────────────────────────────────────
  # 4. macOS 构建 (Intel - x64)
  # ─────────────────────────────────────────────
  build-macos-x64:
    name: Build macOS (Intel x64)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS x64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri
          args: --target x86_64-apple-darwin

      - name: Upload macOS (x64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

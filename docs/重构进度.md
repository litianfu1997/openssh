# 客户端重构进度 (Electron -> Tauri)

本文件记录了将 OpenSSH 客户端从 Electron 迁移到 Tauri 的重构进度，梳理已完成与未完成的工作。

## 1. 架构调整与初始化 (✅ 已完成)
- [x] 初始化 Tauri 工程配置，生成 `src-tauri`。
- [x] 配置 Vite (`vite.config.js`) 以支持 Vue 3 与 Tauri 的集成。
- [x] 调整 `package.json` 中的 `tauri`, `vite:dev`, `vite:build` 启动脚本。

## 2. API 桥接与核心功能迁移
- [x] **IPC 桥接**创建 `src/renderer/src/api/tauri-bridge.js` 替代原 Electron 的 `window.electronAPI`，实现前后端分离调用的统一。
- [x] **数据存储与加密模块** 
  - 通过 `tauri-plugin-store` 实现持久化设置和密码管理。
  - 使用 `aes-gcm` 实现 Rust 版本的 `crypto.rs`，替代 `Node.js` 原生的加密。
  - 创建 `db.rs` 用来包装加密后 Host 的处理。

## 3. 核心功能后端实现 (Rust)
- [x] **主机管理 (db.rs)** 
  - 完成获取列表 `get_hosts`、保存主机 `save_host`、删除主机 `delete_host`、获取单一主机 `get_host` 等功能的实现。
- [x] **SSH 会话模块 (ssh.rs)**
  - 引入 `russh` crate 替代原先 Node.js 下的 ssh2。
  - 完成连接测试 `ssh_test`。
  - 核心会话连接 `ssh_connect` 与命令交互。
  - 实现输入输出 (PTY与管道管理)、重置终端大小 `ssh_resize`、断开连接 `ssh_disconnect`。
- [x] **SFTP 功能模块 (sftp.rs)**
  - 引入 `russh-sftp` crate 以替换 js 的 ssh2 sftp 系统。
  - `sftp_connect_session`: 支持同 SSH 复用宿主，并创建 SFTP。
  - 文件处理:
    - 路径处理 `sftp_realpath`
    - 文件列表 `sftp_list` 及类型转换。
    - 文件编辑相关 `sftp_get_file`, `sftp_put_file`
    - 文件管理 `sftp_mkdir`, `sftp_rename`, `sftp_delete` 等。
  - 文件传输 `sftp_upload`, `sftp_download`: 支持分块传输、控制（暂停 `sftp_pause`、恢复 `sftp_resume`、取消 `sftp_cancel`）与实时进度抛出。

## 4. 前端组件与页面更新
- [x] 修改所有 Vue 组件和脚本以引用 Tauri API（通过 `refactor.js` 统一替换）。
- [x] 适配 `SftpPane.vue` 与 Tauri 通信机制中的部分改动（替换掉 sftp.tree 方法，改为基于 sftp.ls 手动加载子节点，以及使用 `sftpAPI.connect` 完成状态流转）。
- [x] **修复 Tauri 事件监听器管理** (2026-02-24)
  - `TerminalPane.vue`: 修复 `sshAPI.onData/onClosed` 的 Promise 处理，正确保存和调用 unlisten 函数。
  - `SftpPane.vue`: 修复 `sftpAPI.onUploadProgress/onDownloadProgress` 的 Promise 处理，正确管理事件取消订阅。
  - 修复 `SftpPane.vue` 中的中文编码问题（showToast、alert 调用）。
  - 暂时禁用 `tauri_plugin_updater`（需要额外配置）。
- [x] **应用启动验证** (2026-02-24) - `npx tauri dev` 成功启动，前端页面正常渲染。
- [ ] 彻底验证 `SftpPane` 及 `SftpTree` 数据与 UI 的结合（功能测试）。
- [ ] 验证 `TerminalPane.vue`（基于 Xterm.js）是否能正常显示由 `app.emit("ssh:data")` 推送的 Tauri ssh 字符流。
- [ ] 验证设置面板等其他依赖于后端 IPC 的交互。

## 5. 打包与发布 (待处理)
- [ ] 完善 Rust 的应用图标和其他资源（需通过 `tauri icon` 命令）。
- [ ] 验证跨平台编译（Windows 的 .exe / .msi， macOS 的 .app /.dmg 安装包）。
- [ ] 自动更新 `tauri-plugin-updater` 的上线预备。

---
最新更新时间: 2026-02-25
